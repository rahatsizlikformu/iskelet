<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Analiz Paneli</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .dashboard { max-width: 1400px; margin: 20px auto; display: none; }
        .login-container { max-width: 400px; margin: 100px auto; padding: 40px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
        .login-container input { width: 90%; padding: 12px; margin-top: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 14pt; }
        .login-container button { width: 95%; padding: 12px; margin-top: 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 14pt; cursor: pointer; }
        h1, h2 { text-align: center; color: #1c1e21; }
        h3 { border-bottom: 1px solid #ddd; padding-bottom: 8px; margin-bottom: 15px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;}
        .stat-card { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; }
        .stat-card h3 { margin-top: 0; color: #007bff; font-size: 14pt; }
        .stat-card p { font-size: 32px; font-weight: bold; margin: 10px 0 0 0; color: #343a40;}
        .main-content { display: grid; grid-template-columns: 3fr 1fr; gap: 30px; }
        .chart-container, .detail-container { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .pie-charts-grid { display: grid; grid-template-columns: 1fr; gap: 25px; }
        .data-management { text-align: center; margin-top: 40px; padding: 20px; background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; }
        .data-management a { display: inline-block; padding: 12px 25px; background-color: #dc3545; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; }
        @media (max-width: 1200px) { .main-content { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="login-section" class="login-container">
        <h2>Analiz Paneli Girişi</h2>
        <input type="password" id="password" placeholder="Şifrenizi Girin" onkeyup="if(event.keyCode===13) checkPassword()">
        <button onclick="checkPassword()">Giriş Yap</button>
    </div>

    <div id="dashboard-section" class="dashboard">
        <h1>Kas İskelet Sistemi Analiz Paneli</h1>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Toplam Katılımcı</h3>
                <p id="total-participants">...</p>
            </div>
            <div class="stat-card">
                <h3>Ortalama Yaş</h3>
                <p id="average-age">...</p>
            </div>
            <div class="stat-card">
                <h3>Ağrı Prevalansı (12 Ay)</h3>
                <p id="pain-prevalence">...</p>
            </div>
             <div class="stat-card">
                <h3>En Yaygın Ağrı Bölgesi</h3>
                <p id="most-common-pain-area" style="font-size: 24px;">...</p>
            </div>
        </div>

        <div class="main-content">
            <div class="chart-container">
                <h3>Vücut Bölgelerine Göre Ağrı/Sızı Görülme Sıklığı (%)</h3>
                <canvas id="prevalenceBarChart"></canvas>
            </div>
            <div class="detail-container">
                 <h3>Demografik Dağılım</h3>
                 <canvas id="genderPieChart"></canvas>
                 <canvas id="ageGroupBarChart" style="margin-top: 20px;"></canvas>
            </div>
        </div>

        <div class="chart-container" style="margin-top: 30px;">
             <h3>Detaylı Vücut Bölgesi Analizi</h3>
             <div class="stats-grid">
                <div class="pie-charts-grid">
                    <div class="detail-chart-container">
                        <h4>Omuz Ağrısı Detayı</h4>
                        <canvas id="shoulderPieChart"></canvas>
                    </div>
                </div>
                <div class="pie-charts-grid">
                    <div class="detail-chart-container">
                        <h4>Dirsek Ağrısı Detayı</h4>
                        <canvas id="elbowPieChart"></canvas>
                    </div>
                </div>
                <div class="pie-charts-grid">
                     <div class="detail-chart-container">
                        <h4>El/Bilek Ağrısı Detayı</h4>
                        <canvas id="handPieChart"></canvas>
                    </div>
                </div>
             </div>
        </div>

        <div class="data-management">
            <h3>Veri Yönetimi</h3>
            <p>Hatalı veya test amaçlı girilen verileri silmek için aşağıdaki butona tıklayarak Google E-Tablosu'nu açın. Silmek istediğiniz satırın numarasının üzerine sağ tıklayıp "Satırı sil" seçeneğini kullanın. Bu sayfayı yenilediğinizde istatistikler güncellenecektir.</p>
            <a href="https://docs.google.com/spreadsheets/d/1SJ_BeFpMzg-YnoDlzJF5GVEvT_jJYgyowXWfaW9fHOI/edit" target="_blank">Veri Tablosunu Aç ve Yönet</a>
        </div>
    </div>

    <script>
        // --- GİRİŞ FONKSİYONU ---
        function checkPassword() {
            if (document.getElementById('password').value === 'admin44') {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('dashboard-section').style.display = 'block';
                loadAnalytics();
            } else {
                alert('Hatalı şifre!');
            }
        }
        
        // --- GRAFİK YARDIMCI FONKSİYONLARI ---
        function renderChart(ctx, type, labels, data, title, isPercentage = false) {
             const options = {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed !== null) {
                                    label += context.raw;
                                    if(isPercentage) label += '%';
                                }
                                return label;
                            }
                        }
                    }
                }
            };
            if(type === 'bar'){
                options.scales = { y: { beginAtZero: true, ticks: { callback: value => isPercentage ? `${value}%` : value, stepSize: isPercentage ? 10 : undefined } } };
            }
            return new Chart(ctx, { type, data: { labels, datasets: data }, options });
        }
        
        // --- ANA ANALİZ FONKSİYONU ---
        function loadAnalytics() {
            const sheetDB_API_URL = 'https://sheetdb.io/api/v1/8adk03r506ch0';

            fetch(sheetDB_API_URL)
                .then(response => response.json())
                .then(data => {
                    const validData = data.filter(row => row.Uzmanlik && row.Uzmanlik.trim() !== '');
                    
                    if (validData.length === 0) {
                        alert("Henüz analiz edilecek veri bulunmuyor.");
                        return;
                    }
                    
                    const total = validData.length;
                    
                    // --- 1. ÜST KART İSTATİSTİKLERİ ---
                    document.getElementById('total-participants').innerText = total;

                    const totalAge = validData.reduce((sum, row) => sum + parseInt(row.Yas || 0), 0);
                    document.getElementById('average-age').innerText = total > 0 ? (totalAge / total).toFixed(1) : 'N/A';
                    
                    const painRegions = { 'Boyun': 'Boyun_12_Ay', 'Omuzlar': 'Omuzlar_Bolge', 'Dirsekler': 'Dirsekler_Bolge', 'Eller/Bilekler': 'Eller_Bolge', 'Üst Sırt': 'UstSirt_12_Ay', 'Bel Bölgesi': 'AltSirt_12_Ay', 'Kalça/Uyluk': 'Kalca_12_Ay', 'Dizler': 'Diz_12_Ay', 'Ayaklar/Bilekler': 'Ayak_12_Ay' };
                    const painCounts = {};
                    let anyPainCount = 0;
                    const painSufferers = new Set();

                    for (const region in painRegions) {
                        const key = painRegions[region];
                        painCounts[region] = validData.filter(row => row[key] && row[key] !== 'Hayır').length;
                        validData.forEach((row, index) => {
                            if (row[key] && row[key] !== 'Hayır') {
                                painSufferers.add(index);
                            }
                        });
                    }
                    anyPainCount = painSufferers.size;
                    document.getElementById('pain-prevalence').innerText = total > 0 ? `%${((anyPainCount / total) * 100).toFixed(1)}` : 'N/A';
                    
                    const mostCommonPainArea = Object.keys(painCounts).reduce((a, b) => painCounts[a] > painCounts[b] ? a : b);
                    document.getElementById('most-common-pain-area').innerText = mostCommonPainArea;

                    // --- 2. DEMOGRAFİK GRAFİKLER ---
                    const maleCount = validData.filter(r => r.Cinsiyet === 'Erkek').length;
                    renderChart(document.getElementById('genderPieChart').getContext('2d'), 'pie', ['Erkek', 'Kadın'], [{ data: [maleCount, total - maleCount], backgroundColor: ['#007bff', '#ffc0cb'] }], 'Cinsiyet Dağılımı');
                    
                    const ageGroups = { '20-30': 0, '31-40': 0, '41-50': 0, '51+': 0 };
                    validData.forEach(row => {
                        const age = parseInt(row.Yas);
                        if (age <= 30) ageGroups['20-30']++;
                        else if (age <= 40) ageGroups['31-40']++;
                        else if (age <= 50) ageGroups['41-50']++;
                        else ageGroups['51+']++;
                    });
                    renderChart(document.getElementById('ageGroupBarChart').getContext('2d'), 'bar', Object.keys(ageGroups), [{ label: 'Kişi Sayısı', data: Object.values(ageGroups), backgroundColor: '#28a745' }], 'Yaş Grupları');

                    // --- 3. ANA AĞRI DAĞILIMI ( prevalans % olarak) ---
                    const prevalencePercentages = {};
                    for (const region in painCounts) {
                        prevalencePercentages[region] = total > 0 ? ((painCounts[region] / total) * 100).toFixed(1) : 0;
                    }
                    renderChart(document.getElementById('prevalenceBarChart').getContext('2d'), 'bar', Object.keys(prevalencePercentages), [{ label: 'Görülme Sıklığı (%)', data: Object.values(prevalencePercentages), backgroundColor: 'rgba(0, 123, 255, 0.8)' }], 'Bölgesel Ağrı Prevalansı', true);

                    // --- 4. DETAYLI BÖLGE ANALİZİ (PASTA GRAFİKLER) ---
                    const countSide = (key) => ({
                        'Sağ': validData.filter(r => r[key] && r[key].includes('Sağ')).length,
                        'Sol': validData.filter(r => r[key] && r[key].includes('Sol')).length
                    });

                    const shoulderSides = countSide('Omuzlar_Bolge');
                    renderChart(document.getElementById('shoulderPieChart').getContext('2d'), 'pie', ['Sağ', 'Sol'], [{ data: [shoulderSides['Sağ'], shoulderSides['Sol']], backgroundColor: ['#ffc107', '#17a2b8'] }]);
                    
                    const elbowSides = countSide('Dirsekler_Bolge');
                    renderChart(document.getElementById('elbowPieChart').getContext('2d'), 'pie', ['Sağ', 'Sol'], [{ data: [elbowSides['Sağ'], elbowSides['Sol']], backgroundColor: ['#ffc107', '#17a2b8'] }]);
                    
                    const handSides = countSide('Eller_Bolge');
                    renderChart(document.getElementById('handPieChart').getContext('2d'), 'pie', ['Sağ', 'Sol'], [{ data: [handSides['Sağ'], handSides['Sol']], backgroundColor: ['#ffc107', '#17a2b8'] }]);

                })
                .catch(error => {
                    console.error('Veri çekme hatası:', error);
                    alert('Veri tabanına bağlanırken bir hata oluştu.');
                });
        }
    </script>
</body>
</html>
