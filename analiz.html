<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Analiz Paneli</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .dashboard { max-width: 1200px; margin: 20px auto; display: none; }
        .login-container { max-width: 400px; margin: 100px auto; padding: 40px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
        .login-container input { width: 90%; padding: 12px; margin-top: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 14pt; }
        .login-container button { width: 95%; padding: 12px; margin-top: 20px; background-color: #1877f2; color: white; border: none; border-radius: 5px; font-size: 14pt; cursor: pointer; }
        h1, h2, h3 { text-align: center; color: #1c1e21; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .stat-card { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
        .stat-card h3 { margin-top: 0; color: #1877f2; font-size: 14pt; }
        .stat-card p { font-size: 28px; font-weight: bold; margin: 10px 0 0 0; }
        .chart-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-top: 30px; align-items: start; }
        .chart-container, .detail-chart-container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .pie-charts-container { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .data-management { text-align: center; margin-top: 30px; padding: 20px; background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; }
        .data-management a { display: inline-block; padding: 12px 25px; background-color: #dc3545; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; }
        @media (max-width: 900px) { .chart-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="login-section" class="login-container">
        <h2>Analiz Paneli Girişi</h2>
        <input type="password" id="password" placeholder="Şifrenizi Girin" onkeyup="if(event.keyCode===13) checkPassword()">
        <button onclick="checkPassword()">Giriş Yap</button>
    </div>

    <div id="dashboard-section" class="dashboard">
        <h1>Kas İskelet Sistemi Analiz Paneli</h1>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Toplam Katılımcı</h3>
                <p id="total-participants">...</p>
            </div>
            <div class="stat-card">
                <h3>Ortalama Yaş</h3>
                <p id="average-age">...</p>
            </div>
            <div class="stat-card">
                <h3>Cinsiyet Dağılımı</h3>
                <p id="gender-distribution">...</p>
            </div>
            <div class="stat-card">
                <h3>Ağrı Prevalansı</h3>
                <p id="pain-prevalence">...</p>
            </div>
        </div>

        <div class="chart-grid">
            <div class="chart-container">
                <h3>Vücut Bölgelerine Göre Ağrı/Sızı Dağılımı (Son 12 Ay)</h3>
                <canvas id="painDistributionChart" height="400"></canvas>
            </div>
            <div class="pie-charts-container">
                <div class="detail-chart-container">
                    <h3>Omuz Ağrısı Detayı</h3>
                    <canvas id="shoulderPieChart" height="200"></canvas>
                </div>
                <div class="detail-chart-container">
                    <h3>Dirsek Ağrısı Detayı</h3>
                    <canvas id="elbowPieChart" height="200"></canvas>
                </div>
                 <div class="detail-chart-container">
                    <h3>El/Bilek Ağrısı Detayı</h3>
                    <canvas id="handPieChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <div class="data-management">
            <h3>Veri Yönetimi</h3>
            <p>Hatalı veya test amaçlı girilen verileri silmek için aşağıdaki butona tıklayarak Google E-Tablosu'nu açın. Silmek istediğiniz satırın numarasının üzerine sağ tıklayıp "Satırı sil" seçeneğini kullanın. Bu sayfayı yenilediğinizde istatistikler güncellenecektir.</p>
            <!-- VERDİĞİNİZ GOOGLE E-TABLO LİNKİ DOĞRUDAN EKLENDİ -->
            <a href="https://docs.google.com/spreadsheets/d/1SJ_BeFpMzg-YnoDlzJF5GVEvT_jJYgyowXWfaW9fHOI/edit" target="_blank">Veri Tablosunu Aç ve Yönet</a>
        </div>
    </div>

    <script>
        function checkPassword() {
            if (document.getElementById('password').value === 'admin44') {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('dashboard-section').style.display = 'block';
                loadAnalytics();
            } else {
                alert('Hatalı şifre!');
            }
        }

        function loadAnalytics() {
            // VERDİĞİNİZ API LİNKİ DOĞRUDAN EKLENDİ
            const sheetDB_API_URL = 'https://sheetdb.io/api/v1/8adk03r506ch0';

            fetch(sheetDB_API_URL)
                .then(response => response.json())
                .then(data => {
                    // TEKNİK SORUN ÇÖZÜMÜ: Sadece geçerli verileri (Uzmanlık alanı dolu olanları) işle
                    const validData = data.filter(row => row.Uzmanlik && row.Uzmanlik.trim() !== '');
                    
                    if (validData.length === 0) {
                        alert("Henüz analiz edilecek veri bulunmuyor.");
                        return;
                    }
                    
                    const total = validData.length;
                    
                    //--- Üst Kart İstatistikleri ---
                    document.getElementById('total-participants').innerText = total;

                    const totalAge = validData.reduce((sum, row) => sum + parseInt(row.Yas || 0), 0);
                    document.getElementById('average-age').innerText = total > 0 ? (totalAge / total).toFixed(1) : 'N/A';
                    
                    const maleCount = validData.filter(r => r.Cinsiyet === 'Erkek').length;
                    const femaleCount = total - maleCount;
                    document.getElementById('gender-distribution').innerText = `${maleCount} E / ${femaleCount} K`;
                    
                    // Herhangi bir bölgede "Evet" diyenlerin sayısı
                    const anyPainCount = validData.filter(row => 
                        row.Boyun_12_Ay === 'Evet' || (row.Omuzlar_Bolge && row.Omuzlar_Bolge !== 'Hayır') ||
                        (row.Dirsekler_Bolge && row.Dirsekler_Bolge !== 'Hayır') || (row.Eller_Bolge && row.Eller_Bolge !== 'Hayır') ||
                        row.UstSirt_12_Ay === 'Evet' || row.AltSirt_12_Ay === 'Evet' ||
                        row.Kalca_12_Ay === 'Evet' || row.Diz_12_Ay === 'Evet' || row.Ayak_12_Ay === 'Evet'
                    ).length;
                    document.getElementById('pain-prevalence').innerText = total > 0 ? `%${((anyPainCount / total) * 100).toFixed(1)}` : 'N/A';

                    //--- Ana Bar Grafik Verileri ---
                    const painCounts = {
                        'Boyun': validData.filter(r => r.Boyun_12_Ay === 'Evet').length,
                        'Omuzlar': validData.filter(r => r.Omuzlar_Bolge && r.Omuzlar_Bolge !== 'Hayır').length,
                        'Dirsekler': validData.filter(r => r.Dirsekler_Bolge && r.Dirsekler_Bolge !== 'Hayır').length,
                        'Eller/Bilekler': validData.filter(r => r.Eller_Bolge && r.Eller_Bolge !== 'Hayır').length,
                        'Üst Sırt': validData.filter(r => r.UstSirt_12_Ay === 'Evet').length,
                        'Bel Bölgesi': validData.filter(r => r.AltSirt_12_Ay === 'Evet').length,
                        'Kalça/Uyluk': validData.filter(r => r.Kalca_12_Ay === 'Evet').length,
                        'Dizler': validData.filter(r => r.Diz_12_Ay === 'Evet').length,
                        'Ayaklar/Bilekler': validData.filter(r => r.Ayak_12_Ay === 'Evet').length
                    };
                    renderBarChart('painDistributionChart', 'Ağrı/Sızı Bildiren Kişi Sayısı', painCounts);

                    //--- Detay Pasta Grafik Verileri ---
                    const shoulderData = countOccurrences(validData, 'Omuzlar_Bolge', ['Hayır', 'Sağ Omuz', 'Sol Omuz']);
                    renderPieChart('shoulderPieChart', shoulderData);

                    const elbowData = countOccurrences(validData, 'Dirsekler_Bolge', ['Hayır', 'Sağ Dirsek', 'Sol Dirsek']);
                    renderPieChart('elbowPieChart', elbowData);

                    const handData = countOccurrences(validData, 'Eller_Bolge', ['Hayır', 'Sağ El/Bilek', 'Sol El/Bilek']);
                    renderPieChart('handPieChart', handData);

                })
                .catch(error => {
                    console.error('Veri çekme hatası:', error);
                    alert('Veri tabanına bağlanırken bir hata oluştu.');
                });
        }

        //--- Yardımcı Grafik Fonksiyonları ---
        function renderBarChart(canvasId, label, dataObject) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(dataObject),
                    datasets: [{
                        label: label,
                        data: Object.values(dataObject),
                        backgroundColor: 'rgba(24, 119, 242, 0.8)',
                        borderColor: 'rgba(24, 119, 242, 1)',
                        borderWidth: 1
                    }]
                },
                options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, responsive: true, maintainAspectRatio: false }
            });
        }

        function renderPieChart(canvasId, dataObject) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(dataObject),
                    datasets: [{
                        data: Object.values(dataObject),
                        backgroundColor: ['#28a745', '#ffc107', '#007bff', '#dc3545'],
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true }
            });
        }
        
        function countOccurrences(data, key, labels) {
            const counts = {};
            labels.forEach(label => counts[label] = 0);
            data.forEach(row => {
                if (counts.hasOwnProperty(row[key])) {
                    counts[row[key]]++;
                }
            });
            return counts;
        }
    </script>
</body>
</html>
